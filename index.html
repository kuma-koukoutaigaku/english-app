<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CLFZXXHWZQ"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-CLFZXXHWZQ');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ké«˜-è‹±èªãƒã‚§ãƒƒã‚¯</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700&display=swap');
        :root { --primary: #FF9800; --secondary: #1a237e; --bg: #F0F4F8; --perfect: #00C853; --miss: #ff4757; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 50px; }
        .header-area { text-align: center; }
        .main-title { font-family: 'Noto Serif JP', serif; font-size: 1.5rem; color: var(--secondary); border-bottom: 3px solid var(--primary); display: inline-block; }
        .stats-bar { background: #fff; border-radius: 12px; padding: 10px; margin: 15px 0; display: flex; justify-content: space-around; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .menu-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
        .date-tab { background: #fff; border: 1px solid #ddd; padding: 10px 18px; border-radius: 20px; cursor: pointer; white-space: nowrap; }
        .date-tab.active { background: var(--secondary); color: white; }
        .practice-card { background: white; border-radius: 24px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .phrase-item { margin-bottom: 30px; }
        .jp-text { font-size: 1.2rem; font-weight: 800; margin-bottom: 10px; display: block; }
        .word-tap-area { font-size: 1.4rem; margin-bottom: 15px; min-height: 1.5em; }
        .word-chip { cursor: pointer; padding: 2px 4px; display: inline-block; border-bottom: 1px dashed #ccc; margin-right: 5px; color: #333; }
        .word-chip.perfect { color: var(--perfect); font-weight: bold; border-bottom: none; }
        .word-chip.miss { color: #333; font-weight: bold; }
        .word-chip.miss b { color: var(--miss); text-decoration: underline; font-weight: 900; }
        .voice-section { background: #2d3436; border-radius: 15px; padding: 15px; color: #fff; position: relative; }
        .voice-label { font-size: 0.75rem; color: #aaa; display: block; margin-bottom: 5px; }
        .voice-text { font-size: 1.1rem; color: #55efc4; font-weight: bold; padding-right: 90px; }
        .score-display { position: absolute; right: 15px; top: 15px; text-align: center; }
        .score-val { font-size: 1.5rem; font-weight: 900; display: block; }
        .speak-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-top: 10px; box-shadow: 0 4px 0 #E68A00; }
        .speak-btn.recording { background: #d63031 !important; box-shadow: 0 4px 0 #9b2222 !important; }
        .advice-box { margin-top: 10px; background: #fff9db; padding: 12px; border-radius: 10px; font-size: 0.85rem; border-left: 5px solid #fcc419; display: none; color: #333; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="header-area"><h1 class="main-title">é«˜æ ¡é€€å­¦æ•™å¸«ã®Ké«˜ç­‰å­¦æ ¡</h1></div>
    <div class="stats-bar">
        <div>ğŸ”¥ æœ¬æ—¥ã®æŒ‘æˆ¦: <span id="totalCount">0</span>å›</div>
        <div>ğŸ† ç´¯è¨ˆåˆæ ¼æ•°: <span id="passCount">0</span>å€‹</div>
    </div>
    <div id="dateMenu" class="menu-container"></div>
    <div id="content"></div>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmRJRNgjq3OtDdRPDvf3uXywGfHW6_saJSkox9Q0jHOUrg9RzjYCMcCeB8r5aesQUPJo1p1Lvbbm/pub?gid=0&single=true&output=csv';
        let allData = [];
        let recognition = null;
        let isUserStop = false;

        const tips = {
            'th':"ä¸Šé¡ã®å‰æ­¯ã§èˆŒã®å…ˆã‚’è»½ãæŒŸã‚“ã§ã€ãã®éš™é–“ã‹ã‚‰ã€Œã‚¹ãƒƒã€ã¨æ¯ã‚’æ¼ã‚‰ã—ã¦ã¿ã¦ï¼",
            'l':"èˆŒã®å…ˆã‚’ã€Œä¸Šã®å‰æ­¯ã®è£ã®ä»˜ã‘æ ¹ã€ã«ã‚¬ãƒãƒƒã¨æŠ¼ã—å½“ã¦ã¦ã€å£°ã‚’æ¨ªã‹ã‚‰å‡ºã™ã‚¤ãƒ¡ãƒ¼ã‚¸ã ï¼",
            'r':"èˆŒã‚’ã©ã“ã«ã‚‚ä»˜ã‘ãªã„ï¼å£ã®å¥¥ã«ã‚°ã‚¤ãƒƒã¨å¼•ã„ã¦ã€ä¸¡ã‚µã‚¤ãƒ‰ã‚’å¥¥æ­¯ã«å½“ã¦ã‚‹ã‚“ã ï¼",
            'v':"ä¸Šã®å‰æ­¯ã‚’ã€Œä¸‹å”‡ã®å†…å´ã€ã«è»½ãå½“ã¦ã¦ã€å–‰ã‚’éœ‡ã‚ã›ã¦ã€Œãƒ´ãƒ¼ã€ã¨é³´ã‚‰ã™æ„Ÿã˜ã ï¼",
            'f':"ä¸Šã®å‰æ­¯ã§ä¸‹å”‡ã‚’è»½ãæŠ¼ã•ãˆã¦ã€ãã®é–“ã‹ã‚‰å‹¢ã„ã‚ˆãã€Œãƒ•ãƒƒã€ã¨æ¯ã‚’å¹ãå‡ºãã†ï¼",
            's':"ä¸Šä¸‹ã®æ­¯ã‚’è»½ãé–‰ã˜ã€èˆŒã‚’å‰æ­¯ã«è¿‘ã¥ã‘ã¦ã€ç‹­ã„éš™é–“ã‹ã‚‰é‹­ãã€Œã‚¹ãƒƒã€ã¨åã„ã¦ï¼",
            'sh':"å£ã‚’ã‚¿ã‚³ã®ã‚ˆã†ã«å‰ã«çªãå‡ºã—ã€é™ã‹ã«ã•ã›ã‚‹æ™‚ã®ã€Œã‚·ãƒ¼ãƒƒã€ã‚’å¼·ãè¨€ã†ã‚“ã ï¼",
            'ae':"æŒ‡2æœ¬ãŒå…¥ã‚‹ãã‚‰ã„ç¸¦ã«å£ã‚’é–‹ã‘ã€ã€Œã‚¢ã€ã¨è¨€ã„ãªãŒã‚‰ã€Œã‚¨ã€ã®éŸ³ã‚’æ··ãœã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼",
            'ou':"ã€Œã‚ªã€ã¨è¨€ã„å§‹ã‚ã¦ã‹ã‚‰ã€æœ€å¾Œã¯æ€ã„åˆ‡ã‚Šå£ã‚’ã™ã¼ã‚ã¦ã€Œã‚¥ã€ã§çµ‚ã‚ã‚‰ã›ã¦ï¼",
            'ei':"ã€Œã‚¨ã€ã‚’ã¯ã£ãã‚Šè¨€ã£ãŸå¾Œã€å£è§’ã‚’æ¨ªã«å¼•ããªãŒã‚‰ã€Œã‚¤ã€ã‚’æ·»ãˆã‚‹ã¨ã†ã¾ãã„ããï¼",
            'w':"ç¬›ã‚’å¹ãæ™‚ã®ã‚ˆã†ã«å£ã‚’æœ€å°é™ã¾ã§ä¸¸ã‚ã¦çªãå‡ºã—ã€ä¸€æ°—ã«åºƒã’ãªãŒã‚‰å‡ºãã†ï¼",
            'z':"æ­¯ã‚’é–‰ã˜ã¦ã€Œã‚¹ã€ã®å½¢ã®ã¾ã¾ã€å–‰ã®å¥¥ã‚’éœ‡ã‚ã›ã¦ã€Œã‚ºãƒ¼ã€ã¨ãƒãƒã®ç¾½éŸ³ã‚’å‡ºã—ã¦ï¼",
            'ch':"èˆŒå…ˆã‚’ä¸Šé¡ã«ä»˜ã‘ã¦æ¯ã‚’æ­¢ã‚ã€ä¸€æ°—ã«ã€Œãƒãƒƒã€ã¨å¼¾ã‘ã•ã›ã¦æ¯ã‚’å‡ºã™ãŠã†ï¼",
            'dg':"èˆŒå…ˆã‚’ä¸Šé¡ã«æŠ¼ã—å½“ã¦ã¦ã‹ã‚‰ã€å–‰ã‚’éœ‡ã‚ã›ã¦ã€Œãƒ‚ãƒƒã€ã¨åŠ›å¼·ãå‡ºã™ã‚“ã ï¼",
            'm':"ä¸Šä¸‹ã®å”‡ã‚’ã—ã£ã‹ã‚Šé–‰ã˜ã€é¼»ã«éŸ³ã‚’éŸ¿ã‹ã›ã‚‹ã‚ˆã†ã«ã€Œãƒ ãƒ¼ãƒ³ã€ã¨å‡ºã™ã®ãŒã‚³ãƒ„ã ï¼",
            'n':"å”‡ã¯é–‹ã‘ãŸã¾ã¾ã€èˆŒå…ˆã‚’ä¸Šã®æ­¯èŒã«ãƒ™ã‚¿ãƒƒã¨ä»˜ã‘ã¦é¼»ã‹ã‚‰éŸ³ã‚’æŠœã„ã¦ã¿ã¦ï¼",
            'ng':"èˆŒã®ä»˜ã‘æ ¹ã‚’ä¸Šé¡ã®å¥¥ã«æŒã¡ä¸Šã’ã¦ã€å–‰ã®å…¥ã‚Šå£ã‚’å¡ã„ã§é¼»ã‹ã‚‰æŠœãã‚“ã ï¼",
            't':"èˆŒå…ˆã‚’ä¸Šã®æ­¯èŒã«å¼¾ã‹ã›ã¦ã€å£°ã¯å‡ºã•ãšã«ã€Œãƒˆã‚¥ãƒƒã€ã¨é‹­ãæ¯ã‚’é£›ã°ãã†ï¼",
            'd':"èˆŒå…ˆã‚’ä¸Šã®æ­¯èŒã«æŠ¼ã—å½“ã¦ã¦æºœã‚ãŸç©ºæ°—ã‚’ã€å–‰ã‚’éœ‡ã‚ã›ãªãŒã‚‰ã€Œãƒ‰ã‚¥ãƒƒã€ã¨æ”¾ã¦ï¼",
            'b':"å”‡ã‚’ã‚®ãƒ¥ãƒƒã¨çµã‚“ã§æºœã‚ãŸç©ºæ°—ã‚’ã€çˆ†ç™ºã•ã›ã‚‹ã‚ˆã†ã«ã€Œãƒ–ãƒƒã€ã¨å¤–ã«å‡ºãã†ï¼"
        };

        const stats = {
            data: JSON.parse(localStorage.getItem('kHighStats')) || { total: 0, pass: 0, lastDate: "" },
            save() {
                const today = new Date().toLocaleDateString();
                if (this.data.lastDate !== today) { this.data.total = 0; this.data.lastDate = today; }
                localStorage.setItem('kHighStats', JSON.stringify(this.data));
                document.getElementById('totalCount').innerText = this.data.total;
                document.getElementById('passCount').innerText = this.data.pass;
            }
        };

        async function init() {
            stats.save();
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                allData = text.split(/\r?\n/).filter(line => line.includes(',')).map(r => r.split(','));
                const dates = [...new Set(allData.slice(1).map(r => r[0]))].filter(d => d).sort((a,b) => b.localeCompare(a));
                const menu = document.getElementById('dateMenu');
                dates.forEach((d, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'date-tab'; btn.innerText = d;
                    btn.onclick = () => {
                        document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
                        btn.classList.add('active'); render(d);
                    };
                    menu.appendChild(btn);
                    if(i===0) btn.click();
                });
            } catch (e) { console.error(e); }
        }

        function render(date) {
            const container = document.getElementById('content');
            container.innerHTML = '';
            allData.filter(r => r[0] === date).forEach((row, rowIndex) => {
                let items = '';
                for (let j = 2; j <= 10; j += 2) {
                    const en = row[j]?.trim();
                    const jp = row[j+1]?.trim();
                    if (!en || en.length < 2) continue;
                    const id = `item-${rowIndex}-${j}`;
                    items += `
                        <div class="phrase-item">
                            <span class="jp-text">${jp}</span>
                            <div class="word-tap-area" id="area-${id}">${en.split(' ').map(w => `<span class="word-chip" data-orig="${w}" onclick="play('${w.replace(/'/g,"")}')">${w}</span>`).join('')}</div>
                            <div class="voice-section">
                                <span class="voice-label">ã‚­ãƒŸã®è‹±èªï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã¯ã“ã†èã“ãˆã¦ã„ã‚‹ï¼‰</span>
                                <div class="voice-text" id="fb-${id}">...</div>
                                <div class="score-display" id="sc-${id}"></div>
                            </div>
                            <button class="speak-btn" id="btn-${id}" onclick="startCheck('${en.replace(/'/g,"\\'")}', '${id}')">ğŸ¤ åˆ¤å®šã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div class="advice-box" id="ad-${id}"></div>
                        </div>`;
                }
                container.innerHTML += `<div class="practice-card">${items}</div>`;
            });
        }

        function play(t) {
            const u = new SpeechSynthesisUtterance(t); u.lang = 'en-US'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function startCheck(target, id) {
            const btn = document.getElementById(`btn-${id}`);
            const fb = document.getElementById(`fb-${id}`);
            
            if (recognition) {
                isUserStop = true;
                recognition.stop();
                return;
            }

            isUserStop = false;
            btn.classList.add('recording'); btn.innerText = "åœæ­¢ã—ã¦åˆ¤å®š";
            fb.innerText = "èãå–ã‚Šä¸­...";
            
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.onresult = (e) => {
                const result = e.results[0][0].transcript;
                fb.innerText = result;
                judge(target, result, id);
            };
            recognition.onend = () => {
                btn.classList.remove('recording'); btn.innerText = "ğŸ¤ åˆ¤å®šã‚¹ã‚¿ãƒ¼ãƒˆ";
                if (isUserStop && fb.innerText === "èãå–ã‚Šä¸­...") {
                    fb.innerText = "..."; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯æˆ»ã™
                }
                recognition = null;
            };
            recognition.start();
        }

        function judge(target, result, id) {
            const tWords = target.toLowerCase().replace(/[.!?,]/g, "").split(' ');
            const rWords = result.toLowerCase().split(' ');
            const area = document.getElementById(`area-${id}`);
            const chips = area.querySelectorAll('.word-chip');
            const targetKeys = Object.keys(tips).sort((a,b) => b.length - a.length);
            
            let correctCount = 0;
            let firstMissedKey = null;

            tWords.forEach((tw, i) => {
                const chip = chips[i];
                const originalText = chip.getAttribute('data-orig');
                
                if (rWords.includes(tw)) {
                    chip.className = 'word-chip perfect';
                    chip.innerText = originalText;
                    correctCount++;
                } else {
                    chip.className = 'word-chip miss';
                    // å­éŸ³ãƒ»æ¯éŸ³ã®èµ¤å­—åŒ–ãƒ­ã‚¸ãƒƒã‚¯
                    let highlighted = originalText;
                    let foundKeyInThisWord = null;
                    for(let k of targetKeys) {
                        if(tw.includes(k)) {
                            const regex = new RegExp(`(${k})`, 'gi');
                            highlighted = originalText.replace(regex, `<b>$1</b>`);
                            foundKeyInThisWord = k;
                            if(!firstMissedKey) firstMissedKey = k;
                            break; 
                        }
                    }
                    chip.innerHTML = highlighted;
                }
            });

            const score = Math.round((correctCount / tWords.length) * 100);
            stats.data.total++;
            if (score >= 70) {
                stats.data.pass++;
                if(score === 100) confetti();
            }
            stats.save();

            document.getElementById(`sc-${id}`).innerHTML = `<span class="score-val" style="color:${score>=70?'#00C853':'#FF9800'}">${score}ç‚¹</span>`;
            
            const ad = document.getElementById(`ad-${id}`);
            let tipMsg = score >= 70 ? "åˆæ ¼ï¼ãã®èª¿å­ã ã€‚" : "ã‚‚ã†å°‘ã—ãƒãƒƒã‚­ãƒªç™ºéŸ³ã—ã¦ã¿ã‚ˆã†ï¼";
            
            if (score < 100 && firstMissedKey) {
                tipMsg = `ğŸ’¡ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š${firstMissedKey.toUpperCase()}ã®éŸ³ãŒè‹¦æ‰‹ã‹ã‚‚ï¼Ÿ<br>${tips[firstMissedKey]}`;
            }
            ad.innerHTML = tipMsg;
            ad.style.display = "block";
        }

        init();
    </script>
</body>
</html>
