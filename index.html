<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pronunciation Joy ‚ú®</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #FF9800; /* „Ç™„É¨„É≥„Ç∏ */
            --secondary: #673AB7; /* Á¥´ */
            --bg: #F0F4F8;
            --card-bg: #FFFFFF;
            --text: #333;
            --accent: #00C853; /* Á∑ë */
            --error: #FF5252; /* Ëµ§ */
            --info: #2196F3; /* Èùí */
        }
        
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 50px; }
        
        /* „É°„Éã„É•„Éº */
        .menu-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; }
        .date-tab { background: #E0E0E0; color: #666; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; white-space: nowrap; font-weight: bold; }
        .date-tab.active { background: var(--secondary); color: white; box-shadow: 0 4px 10px rgba(103, 58, 183, 0.3); }

        /* „Ç´„Éº„Éâ */
        .practice-card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-top: 8px solid var(--primary); }
        .card-title { font-size: 1.4rem; font-weight: bold; color: var(--secondary); margin-bottom: 20px; text-align: center; display: block; }
        
        .phrase-item { margin-bottom: 25px; background: #FFF9F2; padding: 20px; border-radius: 18px; border: 1px solid #FFE0B2; position: relative; }
        
        /* È†ÜÁï™ÔºöÊó•Êú¨Ë™û ‚Üí Ëã±Ë™û */
        .jp-text { color: #E65100; font-size: 0.9rem; font-weight: bold; margin-bottom: 5px; background: #FFF3E0; display: inline-block; padding: 2px 8px; border-radius: 5px; }
        .target-phrase { font-size: 1.5rem; line-height: 1.3; margin-bottom: 15px; font-weight: bold; color: #1a237e; display: block; }
        
        /* „ÅÇ„Å™„Åü„ÅÆÂ£∞ */
        .feedback-container { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #EEE; position: relative; }
        .feedback-label { font-size: 0.75rem; color: var(--info); font-weight: bold; margin-bottom: 4px; display: block; }
        .feedback-text { font-size: 1.1rem; color: #555; font-style: italic; }
        
        /* „Éú„Çø„É≥ */
        button.speak-btn { 
            width: 100%; background: var(--primary); color: white; border: none; 
            padding: 16px; border-radius: 15px; cursor: pointer; font-weight: bold; 
            font-size: 1.1rem; box-shadow: 0 5px 0 #E68A00; transition: 0.1s;
        }
        button.speak-btn:active { transform: translateY(3px); box-shadow: none; }
        
        /* „Éù„ÉÉ„Éó„Å™ÁÇπÊï∞ */
        .score-box { 
            position: absolute; top: -15px; right: -10px; background: var(--accent); color: white; 
            padding: 8px 12px; border-radius: 50%; font-size: 1.2rem; font-weight: 900; 
            transform: rotate(10deg); box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: none;
        }

        /* YouTube„Éú„Çø„É≥ */
        .yt-button {
            display: block; background: #FF0000; color: white; text-align: center; 
            padding: 12px; border-radius: 12px; text-decoration: none; font-weight: bold; 
            margin-top: 20px; font-size: 0.9rem;
        }
        .yt-button:before { content: "üì∫ "; }

        .status-msg { margin-top: 10px; font-size: 0.9rem; text-align: center; color: #666; font-weight: bold; min-height: 1.2em; }
        .correct { color: var(--accent); }
        .error { color: var(--error); text-decoration: underline; }
    </style>
</head>
<body>
    <h2 style="text-align:center; color: var(--secondary); letter-spacing: 1px;">English Pronunciation Joy ‚ú®</h2>
    <div id="dateMenu" class="menu-container"></div>
    <div id="content">Loading...</div>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmRJRNgjq3OtDdRPDvf3uXywGfHW6_saJSkox9Q0jHOUrg9RzjYCMcCeB8r5aesQUPJo1p1Lvbbm/pub?gid=0&single=true&output=csv';
        let allData = [];

        async function loadData() {
            try {
                const response = await fetch(csvUrl);
                const csvString = await response.text();
                allData = csvString.split(/\r?\n/).map(row => row.split(','));
                createMenu();
            } catch (e) {
                document.getElementById('content').innerHTML = '„Ç®„É©„Éº: CSV„É™„É≥„ÇØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            }
        }

        function createMenu() {
            const menu = document.getElementById('dateMenu');
            const now = new Date();
            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíYYYY/MM/DDÂΩ¢Âºè„Å´Â§âÊèõÔºàÊØîËºÉÁî®Ôºâ
            const todayStr = now.getFullYear() + '/' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                             String(now.getDate()).padStart(2, '0');

            // ‰ªäÊó•„ÅÆÊó•‰ªò‰ª•‰∏ã„ÅÆ„Éá„Éº„Çø„Å†„Åë„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const availableDates = [...new Set(allData.slice(1).map(r => r[0]))]
                .filter(d => d && d.trim() !== "" && d <= todayStr) // ‚òÖ„Åì„Åì„Åå„Éü„ÇΩÔºÅÊú™Êù•„ÅÆÊó•‰ªò„ÅØË¶ã„Åõ„Å™„ÅÑ
                .sort();

            menu.innerHTML = '';
            availableDates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = 'date-tab';
                btn.innerText = date;
                btn.onclick = () => {
                    document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    showByDate(date);
                };
                menu.appendChild(btn);
            });
            if(menu.lastChild) menu.lastChild.click();
            else document.getElementById('content').innerHTML = "Êú¨Êó•„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅØ„Åæ„Å†ÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ";
        }

        function showByDate(targetDate) {
            const container = document.getElementById('content');
            container.innerHTML = '';
            const filteredRows = allData.filter(row => row[0] === targetDate);

            filteredRows.forEach((row, i) => {
                const title = row[1] || "Today's Lesson";
                const youtubeUrl = row[12] ? row[12].trim() : null;
                
                let phrasesHtml = '';
                for (let j = 2; j <= 10; j += 2) {
                    const enText = row[j] ? row[j].trim() : "";
                    const jpText = row[j+1] ? row[j+1].trim() : "";
                    if (enText.length < 2) continue;
                    
                    const id = `phrase-${i}-${j}`;
                    phrasesHtml += `
                        <div class="phrase-item">
                            <div class="score-box" id="score-${id}"></div>
                            <div class="jp-text">üáØüáµ ${jpText}</div>
                            <div class="target-phrase" id="display-${id}">${enText}</div>
                            
                            <div class="feedback-container">
                                <span class="feedback-label">Your Voice</span>
                                <div class="feedback-text" id="feedback-${id}">---</div>
                            </div>
                            
                            <button class="speak-btn" onclick="check('${enText.replace(/'/g, "\\'")}', '${id}')">üé§ Êäº„Åó„Å¶Áô∫Èü≥„ÉÅ„Çß„ÉÉ„ÇØ</button>
                            <div class="status-msg" id="status-${id}"></div>
                        </div>`;
                }

                const ytBtn = youtubeUrl && youtubeUrl.startsWith('http') 
                    ? `<a href="${youtubeUrl}" target="_blank" class="yt-button">„Åì„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅÆËß£Ë™¨ÂãïÁîª„ÇíË¶ã„Çã</a>` 
                    : '';

                container.innerHTML += `
                    <div class="practice-card">
                        <span class="card-title">${title}</span>
                        ${phrasesHtml}
                        ${ytBtn}
                    </div>`;
            });
        }

        function check(target, id) {
            const display = document.getElementById(`display-${id}`);
            const feedback = document.getElementById(`feedback-${id}`);
            const status = document.getElementById(`status-${id}`);
            const scoreBox = document.getElementById(`score-${id}`);
            
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            status.innerText = "ËÅ¥„ÅÑ„Å¶„ÅÑ„Åæ„Åô„Çà...";

            recognition.onresult = (event) => {
                const speech = event.results[0][0].transcript;
                const clean = (s) => s.toLowerCase().replace(/[.!?,]/g, "").trim();
                const tWords = target.split(/\s+/);
                const sWords = clean(speech).split(/\s+/);
                
                feedback.innerHTML = `"${speech}"`;
                
                let correctCount = 0;
                let resultHtml = "";
                tWords.forEach(word => {
                    const isCorrect = sWords.includes(clean(word));
                    if (isCorrect) {
                        correctCount++;
                        resultHtml += `<span class="correct">${word}</span> `;
                    } else {
                        resultHtml += `<span class="error">${word}</span> `;
                    }
                });
                display.innerHTML = resultHtml;

                const score = Math.round((correctCount / tWords.length) * 100);
                scoreBox.innerText = `${score}ÁÇπ`;
                scoreBox.style.display = "block"; // ÁÇπÊï∞„ÇíË°®Á§∫

                if (score === 100) {
                    status.innerText = "‚ú® Perfect! Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ";
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
                } else {
                    status.innerText = "Try again! „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ";
                }
            };
            recognition.start();
        }
        loadData();
    </script>
</body>
</html>
