<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pronunciation Joy ğŸ”¥</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #FF9800; /* å…ƒæ°—ãªã‚ªãƒ¬ãƒ³ã‚¸ */
            --secondary: #673AB7; /* çŸ¥çš„ãªç´« */
            --bg: #F0F4F8; /* çˆ½ã‚„ã‹ãªè–„ã„é’ç™½ */
            --card-bg: #FFFFFF;
            --text: #333333;
            --accent: #00C853; /* æ­£è§£ã®ç·‘ */
            --error: #FF5252; /* é–“é•ã„ã®èµ¤ */
            --info: #2196F3; /* ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é’ */
        }
        
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        /* æ—¥ä»˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; }
        .date-tab { background: #E0E0E0; color: #666; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; white-space: nowrap; font-weight: bold; transition: 0.3s; }
        .date-tab.active { background: var(--secondary); color: white; transform: scale(1.05); }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .practice-card { background: var(--card-bg); border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border-top: 6px solid var(--primary); }
        .yt-link { position: absolute; top: 15px; right: 20px; color: #FF0000; font-size: 2rem; text-decoration: none; }
        
        .card-title { font-size: 1.3rem; font-weight: bold; color: var(--secondary); margin-bottom: 20px; display: block; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .phrase-item { margin-bottom: 20px; background: #fafafa; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        
        /* é…ç½®ï¼šè¦‹å‡ºã—ãŒä¸Š */
        .target-phrase { font-size: 1.4rem; line-height: 1.4; margin-bottom: 8px; font-weight: bold; color: #1a237e; }
        .jp-text { color: #757575; font-size: 1rem; margin-bottom: 15px; font-style: italic; }
        
        /* ã‚ãªãŸã®å£°ã¯ãƒ•ãƒ¬ãƒ¼ã‚ºã®ä¸‹ */
        .feedback-container { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ccc; }
        .feedback-label { font-size: 0.8rem; color: var(--info); font-weight: bold; margin-bottom: 4px; display: block; }
        .feedback-text { font-size: 1.1rem; color: #555; min-height: 1.4em; }
        
        /* ãƒœã‚¿ãƒ³ï¼šã‚·ãƒ¥ãƒƒã¨ã•ã›ãŸã‚ªãƒ¬ãƒ³ã‚¸ */
        button.speak-btn { 
            width: 100%; background: var(--primary); color: white; border: none; 
            padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; 
            font-size: 1.1rem; transition: 0.2s; box-shadow: 0 4px 0 #E68A00;
        }
        button.speak-btn:active { transform: translateY(3px); box-shadow: none; }
        
        .score-display { text-align: right; font-size: 1.5rem; font-weight: 900; color: var(--accent); margin-top: 10px; }
        .status-msg { margin-top: 10px; font-size: 0.9rem; text-align: center; color: #888; font-weight: bold; }
        
        /* å˜èªã”ã¨ã®è‰²ä»˜ã‘ */
        .correct { color: var(--accent); }
        .error { color: var(--error); text-decoration: underline; }
    </style>
</head>
<body>
    <h2 style="text-align:center; color: var(--secondary);">Enjoy English! âœ¨</h2>
    <div id="dateMenu" class="menu-container"></div>
    <div id="content">èª­ã¿è¾¼ã¿ä¸­...</div>

    <script>
        // â˜…ã“ã“ã«è‡ªåˆ†ã®CSVãƒªãƒ³ã‚¯ã‚’è²¼ã‚Šä»˜ã‘ã¦ï¼
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmRJRNgjq3OtDdRPDvf3uXywGfHW6_saJSkox9Q0jHOUrg9RzjYCMcCeB8r5aesQUPJo1p1Lvbbm/pub?gid=0&single=true&output=csv';
        let allData = [];

        async function loadData() {
            try {
                const response = await fetch(csvUrl);
                const csvString = await response.text();
                allData = csvString.split(/\r?\n/).map(row => row.split(','));
                createMenu();
            } catch (e) {
                document.getElementById('content').innerHTML = 'ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
        }

        function createMenu() {
            const menu = document.getElementById('dateMenu');
            const dates = [...new Set(allData.slice(1).map(r => r[0]))].filter(d => d && d.trim() !== "");
            menu.innerHTML = '';
            dates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = 'date-tab';
                btn.innerText = date;
                btn.onclick = () => {
                    document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    showByDate(date);
                };
                menu.appendChild(btn);
            });
            if(menu.lastChild) menu.lastChild.click();
        }

        function showByDate(targetDate) {
            const container = document.getElementById('content');
            container.innerHTML = '';
            const filteredRows = allData.filter(row => row[0] === targetDate);

            filteredRows.forEach((row, i) => {
                const title = row[1] || "Today's Lesson";
                const youtubeUrl = row[12] ? row[12].trim() : null;
                const ytIcon = youtubeUrl && youtubeUrl.startsWith('http') ? `<a href="${youtubeUrl}" target="_blank" class="yt-link">ğŸ“º</a>` : '';

                let phrasesHtml = '';
                for (let j = 2; j <= 10; j += 2) {
                    const enText = row[j] ? row[j].trim() : "";
                    const jpText = row[j+1] ? row[j+1].trim() : "";
                    if (enText.length < 2) continue;
                    
                    const id = `phrase-${i}-${j}`;
                    phrasesHtml += `
                        <div class="phrase-item">
                            <div class="target-phrase" id="display-${id}">${enText}</div>
                            <div class="jp-text">ğŸ‡¯ğŸ‡µ ${jpText}</div>
                            
                            <div class="feedback-container">
                                <span class="feedback-label">ã‚ãªãŸã®å£°</span>
                                <div class="feedback-text" id="feedback-${id}">---</div>
                            </div>
                            
                            <button class="speak-btn" onclick="check('${enText.replace(/'/g, "\\'")}', '${id}')">ğŸ¤ æŠ¼ã—ã¦ç™ºéŸ³ãƒã‚§ãƒƒã‚¯</button>
                            <div class="score-display" id="score-${id}"></div>
                            <div class="status-msg" id="status-${id}"></div>
                        </div>`;
                }
                container.innerHTML += `<div class="practice-card">${ytIcon}<span class="card-title">${title}</span>${phrasesHtml}</div>`;
            });
        }

        function check(target, id) {
            const display = document.getElementById(`display-${id}`);
            const feedback = document.getElementById(`feedback-${id}`);
            const status = document.getElementById(`status-${id}`);
            const scoreDisp = document.getElementById(`score-${id}`);
            
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            status.innerText = "è´ã„ã¦ã„ã¾ã™ã‚ˆï¼ã‚†ã£ãã‚Šè©±ã—ã¦ã­";

            recognition.onresult = (event) => {
                const speech = event.results[0][0].transcript;
                const clean = (s) => s.toLowerCase().replace(/[.!?,]/g, "").trim();
                
                const tWords = target.split(/\s+/);
                const sWords = clean(speech).split(/\s+/);
                
                feedback.innerHTML = `"${speech}"`;
                
                let correctCount = 0;
                let resultHtml = "";
                tWords.forEach(word => {
                    const isCorrect = sWords.includes(clean(word));
                    if (isCorrect) {
                        correctCount++;
                        resultHtml += `<span class="correct">${word}</span> `;
                    } else {
                        resultHtml += `<span class="error">${word}</span> `;
                    }
                });
                display.innerHTML = resultHtml;

                const score = Math.round((correctCount / tWords.length) * 100);
                scoreDisp.innerText = `${score}ç‚¹`;

                if (score === 100) {
                    status.innerText = "âœ¨ å®Œç’§ï¼å¤©æ‰ã§ã™ã­ï¼";
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 } });
                } else if (score >= 60) {
                    status.innerText = "ğŸ˜Š ã„ã„æ„Ÿã˜ï¼ã‚ã¨ä¸€æ­©ï¼";
                } else {
                    status.innerText = "ğŸ”¥ ã©ã‚“ã¾ã„ï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
                }
            };
            recognition.start();
        }
        loadData();
    </script>
</body>
</html>
